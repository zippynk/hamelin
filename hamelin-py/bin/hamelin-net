#!/usr/bin/env python
import hamelin
import errno
import socket
import sys
import time
import threading
import inspect

class netdaemon(hamelin.daemon):
    def run(self, host='', port=8080):
        print "Running at host %s on port %d" % (host, port)
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.bind((host, port))
        s.listen(5)
        while True:
            accepted = s.accept()
            t = threading.Thread(
                target = self.server_loop,
                args   = accepted,
                name   = "net-server-%s:%d" % accepted[1])
            t.start()

    def server_loop(self, conn, add):
        self.serv = self.create_server({
            'H-VERSION': 'HAMELIN.PY-NET-0.1',
            'H-CLIENT': "{0}:{1}".format(add[0], add[1])
        })

        def recv(text):
            try:
                conn.sendall(text)
            except socket.error:
                print "Write failed with error. Killing server."
                self.serv.kill()

        def quit(code):
            try:
                conn.shutdown(socket.SHUT_RDWR)
            except socket.error as err:
                if err.errno == errno.ENOTCONN:
                    print "Client disconnected (probably a ^C)."
            conn.close()

        self.serv.handle_data = recv
        self.serv.handle_quit = quit
        self.serv.startup()
        buf = ""
        while self.serv.alive:
            try:
                d = conn.recv(4096)
                buf += d
                if len(d) == 0:
                    self.serv.eof()
                    return
                if "\n" in buf:
                    line, buf = buf.split("\n", 1)
                    self.serv.send(line + "\n")
            except socket.error as err:
                if err.errno == errno.ECONNRESET:
                    print "Connection reset."
                print "Oh no, the socket died and threw an error."
                self.serv.kill()
                break


def main():
    if len(sys.argv) < 4:
        print "Usage: hamelin-net [host] [port] [args...]"
        exit(1)

    host = sys.argv[1]
    port = int(sys.argv[2])
    args = sys.argv[3:]
    mainNetdaemon = netdaemon(args)
    try:
        mainNetdaemon.run(host=host, port=port)
    except KeyboardInterrupt:
        if "serv" in inspect.getmembers(mainNetdaemon):
            if mainNetdaemon.serv.alive:
                mainNetdaemon.serv.kill()
                print "\nYikes. Shutting down server." # The \n is here so that it doesn't print it right after the ^C.
            else:
                print "\nYikes." # The \n is here so that it doesn't print it right after the ^C.
        else:
            print "\nYikes." # The \n is here so that it doesn't print it right after the ^C

if __name__ == '__main__':
    main()
